name: apptremind

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_SUPERUSER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_SUPERUSER_PASSWORD:-postgres}
      POSTGRES_DB: postgres
      AUTH_DB_PASSWORD: ${AUTH_DB_PASSWORD:-auth_password}
      BUSINESS_DB_PASSWORD: ${BUSINESS_DB_PASSWORD:-business_password}
      BOOKING_DB_PASSWORD: ${BOOKING_DB_PASSWORD:-booking_password}
      BILLING_DB_PASSWORD: ${BILLING_DB_PASSWORD:-billing_password}
      SCHEDULER_DB_PASSWORD: ${SCHEDULER_DB_PASSWORD:-scheduler_password}
      NOTIFICATION_DB_PASSWORD: ${NOTIFICATION_DB_PASSWORD:-notification_password}
      ANALYTICS_DB_PASSWORD: ${ANALYTICS_DB_PASSWORD:-analytics_password}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 30

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD-SHELL", "echo imok"]
      interval: 10s
      timeout: 5s
      retries: 30

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
    volumes:
      - kafka-data:/var/lib/kafka/data
    ports:
      - "9092:9092"
    depends_on:
      zookeeper:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30

  mailpit:
    image: axllent/mailpit:latest
    ports:
      - "8025:8025" # UI
      - "1025:1025" # SMTP

  jaeger:
    image: jaegertracing/all-in-one:1.53
    ports:
      - "16686:16686" # UI
      - "4317:4317"   # OTLP gRPC

  gateway-service:
    build:
      context: ../..
      dockerfile: build/Dockerfile.go-service
      args:
        SERVICE: gateway-service
    environment:
      SERVICE_NAME: gateway-service
      PORT: "8080"
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
      OTEL_SAMPLING_RATIO: "1"
      AUTH_URL: http://auth-service:8081
      BUSINESS_URL: http://business-service:8082
      BOOKING_URL: http://booking-service:8083
      BILLING_URL: http://billing-service:8084
      JWT_SECRET: dev-secret
      RATE_LIMIT_PER_MINUTE: "60"
      REDIS_ADDR: redis:6379
      RATE_LIMIT_PREFIX: apptremind:gateway:rl
      RATE_LIMIT_FAIL_OPEN: "true"
      REQUEST_BODY_LIMIT_BYTES: "1048576"
      REQUEST_TIMEOUT_SECONDS: "10"
      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://127.0.0.1:3000,http://localhost:5173,http://localhost:8088,http://127.0.0.1:8088
      CORS_ALLOWED_METHODS: GET,POST,PUT,PATCH,DELETE,OPTIONS
      CORS_ALLOWED_HEADERS: Authorization,Content-Type,X-Request-Id,X-Idempotency-Key
      CORS_ALLOW_CREDENTIALS: "false"
      CORS_MAX_AGE_SECONDS: "600"
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy

  auth-service:
    build:
      context: ../..
      dockerfile: build/Dockerfile.go-service
      args:
        SERVICE: auth-service
    environment:
      SERVICE_NAME: auth-service
      PORT: "8081"
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
      OTEL_SAMPLING_RATIO: "1"
      DATABASE_URL: postgres://auth_user:${AUTH_DB_PASSWORD:-auth_password}@postgres:5432/auth_db?sslmode=disable
      JWT_SECRET: dev-secret
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka:9092}
    depends_on:
      postgres:
        condition: service_healthy

  business-service:
    build:
      context: ../..
      dockerfile: build/Dockerfile.go-service
      args:
        SERVICE: business-service
        GO_TAGS: protogen
    environment:
      SERVICE_NAME: business-service
      PORT: "8082"
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
      OTEL_SAMPLING_RATIO: "1"
      DATABASE_URL: postgres://business_user:${BUSINESS_DB_PASSWORD:-business_password}@postgres:5432/business_db?sslmode=disable
      GRPC_PORT: "9090"
      REMINDER_OFFSETS_MINUTES: "1440,60"
    depends_on:
      postgres:
        condition: service_healthy

  booking-service:
    build:
      context: ../..
      dockerfile: build/Dockerfile.go-service
      args:
        SERVICE: booking-service
        GO_TAGS: protogen
    environment:
      SERVICE_NAME: booking-service
      PORT: "8083"
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
      OTEL_SAMPLING_RATIO: "1"
      DATABASE_URL: postgres://booking_user:${BOOKING_DB_PASSWORD:-booking_password}@postgres:5432/booking_db?sslmode=disable
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka:9092}
      REMINDER_OFFSETS_MINUTES: "1440,60"
      BUSINESS_GRPC_ADDR: business-service:9090
      KAFKA_CONSUME_TOPIC: billing.subscription.activated.v1
      KAFKA_CONSUME_TOPIC_2: billing.subscription.canceled.v1
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy

  billing-service:
    build:
      context: ../..
      dockerfile: build/Dockerfile.go-service
      args:
        SERVICE: billing-service
        GO_TAGS: protogen
    environment:
      SERVICE_NAME: billing-service
      PORT: "8084"
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
      OTEL_SAMPLING_RATIO: "1"
      DATABASE_URL: postgres://billing_user:${BILLING_DB_PASSWORD:-billing_password}@postgres:5432/billing_db?sslmode=disable
      GRPC_PORT: "9091"
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka:9092}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_WEBHOOK_TOLERANCE_SECONDS: ${STRIPE_WEBHOOK_TOLERANCE_SECONDS:-300}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PRICE_STARTER: ${STRIPE_PRICE_STARTER:-}
      STRIPE_PRICE_PRO: ${STRIPE_PRICE_PRO:-}
      CHECKOUT_SUCCESS_URL: ${CHECKOUT_SUCCESS_URL:-http://localhost:8080/billing/success?session_id={CHECKOUT_SESSION_ID}}
      CHECKOUT_CANCEL_URL: ${CHECKOUT_CANCEL_URL:-http://localhost:8080/billing/cancel?session_id={CHECKOUT_SESSION_ID}}
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy

  scheduler-service:
    build:
      context: ../..
      dockerfile: build/Dockerfile.go-service
      args:
        SERVICE: scheduler-service
    environment:
      SERVICE_NAME: scheduler-service
      PORT: "8087"
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
      OTEL_SAMPLING_RATIO: "1"
      DATABASE_URL: postgres://scheduler_user:${SCHEDULER_DB_PASSWORD:-scheduler_password}@postgres:5432/scheduler_db?sslmode=disable
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka:9092}
      KAFKA_CONSUME_TOPIC: booking.reminder.requested.v1
      SCHEDULER_BACKOFF_SECONDS: "60"
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy

  notification-service:
    build:
      context: ../..
      dockerfile: build/Dockerfile.go-service
      args:
        SERVICE: notification-service
    environment:
      SERVICE_NAME: notification-service
      PORT: "8085"
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
      OTEL_SAMPLING_RATIO: "1"
      DATABASE_URL: postgres://notification_user:${NOTIFICATION_DB_PASSWORD:-notification_password}@postgres:5432/notification_db?sslmode=disable
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka:9092}
      KAFKA_CONSUME_TOPIC: scheduler.reminder.due.v1
      SMTP_HOST: mailpit
      SMTP_PORT: "1025"
      SMS_PROVIDER: noop
      SMS_WEBHOOK_URL: ""
      SMS_WEBHOOK_TOKEN: ""
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      mailpit:
        condition: service_started

  analytics-service:
    build:
      context: ../..
      dockerfile: build/Dockerfile.go-service
      args:
        SERVICE: analytics-service
    environment:
      SERVICE_NAME: analytics-service
      PORT: "8086"
      OTEL_EXPORTER_OTLP_ENDPOINT: jaeger:4317
      OTEL_SAMPLING_RATIO: "1"
      DATABASE_URL: postgres://analytics_user:${ANALYTICS_DB_PASSWORD:-analytics_password}@postgres:5432/analytics_db?sslmode=disable
      KAFKA_BROKERS: ${KAFKA_BROKERS:-kafka:9092}
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy

  swagger-ui:
    image: swaggerapi/swagger-ui:v5.17.14
    environment:
      SWAGGER_JSON_URL: http://localhost:8080/openapi
      BASE_URL: /docs
    ports:
      - "8088:8080"
    depends_on:
      gateway-service:
        condition: service_started

  kafka-tools:
    image: edenhill/kcat:1.7.1
    entrypoint: ["/bin/sh", "-c", "tail -f /dev/null"]
    depends_on:
      kafka:
        condition: service_healthy

  kafka-init:
    image: confluentinc/cp-kafka:7.6.0
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Creating Kafka topics..." &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic booking.appointment.booked.v1 --partitions 1 --replication-factor 1 &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic booking.appointment.cancelled.v1 --partitions 1 --replication-factor 1 &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic booking.reminder.requested.v1 --partitions 1 --replication-factor 1 &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic auth.user.created.v1 --partitions 1 --replication-factor 1 &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic auth.audit.v1 --partitions 1 --replication-factor 1 &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic billing.subscription.activated.v1 --partitions 1 --replication-factor 1 &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic billing.subscription.canceled.v1 --partitions 1 --replication-factor 1 &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic scheduler.reminder.due.v1 --partitions 1 --replication-factor 1 &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic scheduler.reminder.dlq.v1 --partitions 1 --replication-factor 1 &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification.sent.v1 --partitions 1 --replication-factor 1 &&
        kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notification.failed.v1 --partitions 1 --replication-factor 1 &&
        echo "Kafka topics ready."
    depends_on:
      kafka:
        condition: service_healthy

volumes:
  postgres-data:
  kafka-data:
